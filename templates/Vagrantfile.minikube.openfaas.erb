# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

  config.vm.box = "centos/8"
    config.vm.network "private_network", ip: "192.168.50.4"

  # docker daemon
  config.vm.network "forwarded_port", guest: 2375, host: 2375, auto_correct: false
  # registry
  config.vm.network "forwarded_port", guest: 5000, host: 5000, auto_correct: false
  # kubernetes dashboard
  config.vm.network "forwarded_port", guest: 5080, host: 5080, auto_correct: false
  # openfaas gateway
  config.vm.network "forwarded_port", guest: 8080, host: 5180, auto_correct: false

  
  config.vm.provider "virtualbox" do |vb|
  vb.gui = false
  vb.memory = "8192"
	vb.cpus = 4
  end

  config.vm.provision "shell", inline: <<-SHELL            
  sed -i s/SELINUX=enforcing/SELINUX=permissive/g /etc/selinux/config #disable SElinux
  yum install -y epel-release
  yum clean all
  yum install -y gcc\
      kernel-devel\
      kernel-headers\
      dkms\
      make\
      bzip2\
      perl\
      mock\
      git\
      rpm-build\
      rpmdevtools\
      httpd\
      createrepo\
      genisoimage\
      yum-utils\
      createrepo\
      mkisofs\
      wget\
      git\
      syslinux\
      isomd5sum          
  cd /vagrant/scripts
  echo "################## building chroot #########################"  
  sudo bash build_chroot.sh /home/vagrant/chroot x86_64 7
  echo "################## finished building chroot #########################"
SHELL

  config.vm.provision "shell", inline: <<-SHELL  
  echo "################## building minikube #########################"  
    cd /vagrant/scripts
    chmod +x *.sh
    ./deploy-minikube-openfaas
  echo "################## finished building minikube #########################"    
  SHELL
end